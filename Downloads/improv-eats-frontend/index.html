 <!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImprovEats Recipe Finder</title>
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            /* Light mode colors */
            --bg-primary: #fff7ed;
            --bg-secondary: #fed7aa;
            --bg-card: white;
            --bg-input: rgba(168, 213, 186, 0.8);
            --bg-input-hover: rgba(168, 213, 186, 1);
            --bg-button: #8FB9CA;
            --bg-button-hover: #7AA5B8;
            --bg-tag: #fed7aa;
            --text-primary: #333333;
            --text-secondary: #6b7280;
            --text-accent: #ea580c;
            --text-tag: #ea580c;
            --border: #d1d5db;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --bg-card: #2a2a2a;
            --bg-input: rgba(60, 60, 60, 0.8);
            --bg-input-hover: rgba(70, 70, 70, 1);
            --bg-button: #4a5568;
            --bg-button-hover: #2d3748;
            --bg-tag: #4a5568;
            --text-primary: #e2e8f0;
            --text-secondary: #a0aec0;
            --text-accent: #ff7c3a;
            --text-tag: #e2e8f0;
            --border: #4a5568;
            --shadow: rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            min-height: 100vh;
            padding: 1rem;
            color: var(--text-primary);
            transition: background 0.3s ease, color 0.3s ease;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        /* Login Page Styles */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
        }

        .login-card {
            background: rgba(168, 213, 186, 0.6);
            border-radius: 2rem;
            padding: 3rem 2.5rem;
            width: 100%;
            max-width: 400px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
        }

        .login-title {
            text-align: center;
            font-size: 2.5rem;
            font-weight: bold;
            color: #333333;
            margin-bottom: 2rem;
        }

        .login-form {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-input {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 1.5rem;
            background: rgba(168, 213, 186, 0.8);
            color: #333333;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .form-input::placeholder {
            color: #333333;
            opacity: 0.8;
        }

        .form-input:focus {
            outline: none;
            background: rgba(168, 213, 186, 1);
        }

        .login-btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 1.5rem;
            background: rgba(168, 213, 186, 0.8);
            color: #333333;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .login-btn:hover {
            background: rgba(168, 213, 186, 1);
        }

        .theme-toggle {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: var(--bg-card);
            border: 2px solid var(--border);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.5rem;
            transition: all 0.3s ease;
            z-index: 1000;
            box-shadow: 0 4px 6px var(--shadow);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 8px var(--shadow);
        }

        .divider {
            text-align: center;
            margin: 1.5rem 0;
            color: #333333;
            font-size: 1.1rem;
            font-weight: 500;
        }

        .google-btn {
            padding: 1rem 1.5rem;
            border: none;
            border-radius: 1.5rem;
            background: #f3f4f6;
            color: #374151;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 2rem;
        }

        .google-btn:hover {
            background: #e5e7eb;
        }

        .register-link {
            text-align: center;
            color: #333333;
            font-size: 1rem;
            margin-bottom: 2rem;
        }

        .register-link a {
            color: #333333;
            text-decoration: underline;
            font-weight: 600;
        }

        .guest-link {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            color: #333333;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            text-decoration: none;
            transition: color 0.2s;
        }

        .guest-link:hover {
            color: #ea580c;
        }

        .error-message {
            background: #fef2f2;
            color: #dc2626;
            padding: 0.75rem;
            border-radius: 0.5rem;
            margin-bottom: 1rem;
            text-align: center;
            font-size: 0.875rem;
        }

        /* Original Recipe App Styles */
        .header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .header-title {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin-bottom: 1rem;
        }

        .header-title h1 {
            font-size: 2.25rem;
            font-weight: bold;
            color: #ea580c;
        }

        .header-subtitle {
            color: #9a3412;
            font-size: 1.125rem;
        }

        .user-info {
            text-align: center;
            margin-bottom: 1rem;
            color: #333333;
        }

        .logout-btn {
            background: #dc2626;
            color: white;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            margin-left: 1rem;
        }

        .logout-btn:hover {
            background: #b91c1c;
        }

        .streak-display {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.75rem;
            margin: 1rem 0;
            padding: 1rem;
            background: linear-gradient(135deg, #fff7ed 0%, #fed7aa 100%);
            border-radius: 1rem;
            border: 2px solid #f97316;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .streak-icon {
            font-size: 2rem;
        }

        .streak-info {
            text-align: center;
        }

        .streak-number {
            font-size: 1.5rem;
            font-weight: bold;
            color: #ea580c;
        }

        .streak-label {
            font-size: 0.875rem;
            color: #9a3412;
            font-weight: 500;
        }

        .card {
            background: var(--bg-card);
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px var(--shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .input-section {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1.5rem;
        }

        .input-wrapper {
            flex: 1;
            position: relative;
        }

        .input-wrapper svg {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        .input-field {
            width: 100%;
            padding: 0.75rem 0.75rem 0.75rem 2.5rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            font-size: 1rem;
            background: var(--bg-card);
            color: var(--text-primary);
        }

        .input-field:focus {
            outline: none;
            border-color: var(--bg-button);
            box-shadow: 0 0 0 2px rgba(143, 185, 202, 0.2);
        }

        .add-btn {
            padding: 0.75rem 1.5rem;
            background: var(--bg-button);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            transition: background-color 0.2s;
        }

        .add-btn:hover {
            background: var(--bg-button-hover);
        }

        .ingredients-section h3 {
            font-size: 1.125rem;
            font-weight: 600;
            margin-bottom: 0.75rem;
            color: #1f2937;
        }

        .ingredients-list {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .ingredient-tag {
            background: var(--bg-tag);
            color: var(--text-tag);
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.875rem;
        }

        .remove-btn {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .remove-btn:hover {
            background: #fb923c;
        }

        .recipes-header {
        font-size: 1.5rem;
        font-weight: bold;
        color: #ea580c;
        position: relative;
        top: -10px;
        }

        .recipe-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1rem;
            cursor: pointer;
            border-left: 4px solid var(--bg-button);
            transition: box-shadow 0.2s;
            position: relative;
        }

        .recipe-card:hover {
            box-shadow: 0 20px 25px -5px var(--shadow);
        }

        .star-btn {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: background-color 0.2s;
            z-index: 10;
        }

        .star-btn:hover {
            background: rgba(0, 0, 0, 0.1);
        }

        .star-icon {
            width: 20px;
            height: 20px;
            fill: none;
            stroke: #d1d5db;
            stroke-width: 2;
        }

        .star-icon.starred {
            fill: #fbbf24;
            stroke: #f59e0b;
        }

        .recipe-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 0.75rem;
        }

        .recipe-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ea580c;
        }

        .match-score {
            text-align: right;
        }

        .match-percentage {
            font-size: 1.125rem;
            font-weight: bold;
            color: #f97316;
        }

        .match-label {
            font-size: 0.75rem;
            color: #6b7280;
        }

        .recipe-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            color: #6b7280;
        }

        .meta-item {
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.875rem;
        }

        .ingredients-info {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .ingredient-line {
            font-size: 0.875rem;
        }

        .have-ingredients {
            color: #f97316;
        }

        .need-ingredients {
            color: #dc2626;
        }

        .label {
            font-weight: 500;
        }

        .no-recipes {
            text-align: center;
            padding: 2rem;
            background: var(--bg-card);
            border-radius: 0.75rem;
        }

        .no-recipes svg {
            color: #9ca3af;
            margin: 0 auto 1rem;
        }

        .no-recipes p {
            color: #6b7280;
            font-size: 1.125rem;
            margin-bottom: 0.5rem;
        }

        .no-recipes .subtitle {
            color: #9ca3af;
            font-size: 1rem;
        }

        .recipe-detail {
            max-width: 800px;
            margin: 0 auto;
        }

        .back-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: #f97316;
            background: none;
            border: none;
            font-size: 1rem;
            cursor: pointer;
            margin-bottom: 1.5rem;
            padding: 0.5rem;
        }

        .back-btn:hover {
            color: #ea580c;
        }

        .recipe-detail-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 1.5rem;
        }

        .recipe-detail-title {
            font-size: 1.875rem;
            font-weight: bold;
            color: #ea580c;
            margin-bottom: 0.5rem;
        }

        .recipe-detail-meta {
            display: flex;
            align-items: center;
            gap: 1rem;
            color: #6b7280;
        }

        .detail-actions {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 1rem;
        }

        .finish-cooking-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .finish-cooking-btn:hover {
            background: #059669;
        }

        .remove-history-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: background-color 0.2s;
        }

        .remove-history-btn:hover {
            background: #b91c1c;
        }

        .history-item {
            background: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #10b981;
            cursor: pointer;
        }

        .history-date {
            color: #6b7280;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .achievement-card {
            background: var(--bg-card);
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px var(--shadow);
            padding: 1.5rem;
            margin-bottom: 1rem;
            border-left: 4px solid #fbbf24;
            position: relative;
        }

        .achievement-card.locked {
            border-left-color: #9ca3af;
            opacity: 0.6;
        }

        .achievement-card.completed {
            border-left-color: #10b981;
            background: linear-gradient(135deg, #f0fdf4 0%, #dcfce7 100%);
        }

        .achievement-header {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 0.75rem;
        }

        .achievement-icon {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .achievement-icon.completed {
            background: #10b981;
            color: white;
        }

        .achievement-icon.locked {
            background: #9ca3af;
            color: white;
        }

        .achievement-info h3 {
            font-size: 1.25rem;
            font-weight: 600;
            color: #ea580c;
            margin-bottom: 0.25rem;
        }

        .achievement-info.completed h3 {
            color: #10b981;
        }

        .achievement-info.locked h3 {
            color: #6b7280;
        }

        .achievement-description {
            color: #6b7280;
            font-size: 0.875rem;
        }

        .achievement-progress {
            margin-top: 0.75rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: #fbbf24;
            transition: width 0.3s ease;
        }

        .progress-fill.completed {
            background: #10b981;
        }

        .progress-text {
            font-size: 0.75rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .recipe-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 2rem;
        }

        .ingredients-section h3,
        .instructions-section h3 {
            font-size: 1.25rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: #ea580c;
        }

        .ingredient-item {
            padding: 0.5rem;
            border-radius: 0.5rem;
            border: 1px solid;
            margin-bottom: 0.5rem;
        }

        .ingredient-have {
            background: rgba(249, 115, 22, 0.1);
            border-color: #f97316;
            color: #333333;
        }

        .ingredient-need {
            background: rgba(221, 214, 206, 0.3);
            border-color: #DDD6CE;
            color: #333333;
        }

        .ingredient-status {
            font-size: 0.75rem;
            margin-left: 0.5rem;
        }

        .instructions-list {
            list-style: none;
        }

        .instruction-item {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 0.75rem;
        }

        .instruction-number {
            flex-shrink: 0;
            width: 1.5rem;
            height: 1.5rem;
            background: #f97316;
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.875rem;
            font-weight: 600;
        }

        .instruction-text {
            color: #333333;
            line-height: 1.5;
        }

        @media (max-width: 768px) {
            .recipe-content {
                grid-template-columns: 1fr;
            }

            .input-section {
                flex-direction: column;
            }

            .recipe-header {
                flex-direction: column;
                gap: 0.5rem;
            }
        }

        .hidden {
            display: none;
        }

        .tabs-container {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .tab-btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            background: #f3f4f6;
            color: #6b7280;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: all 0.2s;
        }

        .tab-btn:hover {
            background: #e5e7eb;
        }

        .tab-btn.active {
            background: #8FB9CA;
            color: white;
        }

        /* Timer Integration Styles */
        .instruction-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            gap: 1rem;
        }

        .timer-btn {
            padding: 0.5rem 0.75rem;
            background: #10b981;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            transition: background-color 0.2s;
            min-width: 80px;
        }

        .timer-btn:hover {
            background: #059669;
        }

        .timer-btn.timer-running {
            background: #f59e0b;
            animation: pulse 1s infinite;
        }

        .timer-btn.timer-done {
            background: #dc2626;
            animation: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* Recipe Scaling Styles */
        .servings-controls {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
        }

        .serving-btn {
            width: 30px;
            height: 30px;
            border: 2px solid var(--bg-button);
            background: transparent;
            color: var(--bg-button);
            border-radius: 50%;
            cursor: pointer;
            font-size: 1rem;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .serving-btn:hover {
            background: var(--bg-button);
            color: white;
        }

        /* Recipe Export Styles */
        .export-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: #8b5cf6;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .export-btn:hover {
            background: #7c3aed;
        }

        /* Recipe Notes & Ratings Styles */
        .notes-section {
            margin-top: 2rem;
            padding: 1.5rem;
            background: var(--bg-card);
            border-radius: 0.75rem;
            border: 1px solid var(--border);
        }

        .notes-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }

        .notes-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--text-accent);
        }

        .rating-container {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .rating-stars {
            display: flex;
            gap: 0.25rem;
        }

        .star-rating {
            width: 24px;
            height: 24px;
            cursor: pointer;
            color: #d1d5db;
            font-size: 20px;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .star-rating:hover,
        .star-rating.filled {
            color: #fbbf24;
        }

        .rating-text {
            font-size: 0.875rem;
            color: var(--text-secondary);
            margin-left: 0.5rem;
        }

        .notes-input {
            width: 100%;
            min-height: 100px;
            padding: 0.75rem;
            border: 1px solid var(--border);
            border-radius: 0.5rem;
            background: var(--bg-card);
            color: var(--text-primary);
            font-size: 0.875rem;
            resize: vertical;
            font-family: inherit;
            margin-bottom: 1rem;
        }

        .notes-input:focus {
            outline: none;
            border-color: var(--bg-button);
            box-shadow: 0 0 0 2px rgba(143, 185, 202, 0.2);
        }

        .notes-input::placeholder {
            color: var(--text-secondary);
        }

        .notes-actions {
            display: flex;
            gap: 0.5rem;
        }

        .save-notes-btn {
            padding: 0.5rem 1rem;
            background: var(--bg-button);
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .save-notes-btn:hover {
            background: var(--bg-button-hover);
        }

        .clear-notes-btn {
            padding: 0.5rem 1rem;
            background: #dc2626;
            color: white;
            border: none;
            border-radius: 0.5rem;
            cursor: pointer;
            font-size: 0.875rem;
            transition: background-color 0.2s;
        }

        .clear-notes-btn:hover {
            background: #b91c1c;
        }

        /* AI Recipe Generation Styles */
        .ai-generate-section {
            margin-top: 1rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, #e0f2fe 0%, #b3e5fc 100%);
            border-radius: 1rem;
            border: 2px solid #0288d1;
        }

        .ai-generate-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem 2rem;
            background: linear-gradient(135deg, #0288d1 0%, #0277bd 100%);
            color: white;
            border: none;
            border-radius: 0.75rem;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(2, 136, 209, 0.3);
            width: 100%;
            justify-content: center;
        }

        .ai-generate-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, #0277bd 0%, #01579b 100%);
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(2, 136, 209, 0.4);
        }

        .ai-generate-btn:disabled {
            background: #9e9e9e;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .ai-generate-text {
            text-align: center;
            margin-bottom: 1rem;
            color: #01579b;
            font-weight: 600;
        }

        .loading-spinner {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .ai-recipe-badge {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            background: linear-gradient(135deg, #4fc3f7 0%, #29b6f6 100%);
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 1rem;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 0.5rem;
        }

        .existing-notes {
            background: rgba(249, 115, 22, 0.1);
            border: 1px solid rgba(249, 115, 22, 0.3);
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .existing-notes-text {
            color: var(--text-primary);
            line-height: 1.5;
            font-size: 0.875rem;
            white-space: pre-wrap;
        }

        .recipe-rating-display {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-left: 1rem;
            padding: 0.5rem 0.75rem;
            background: rgba(251, 191, 36, 0.1);
            border-radius: 0.5rem;
            border: 1px solid rgba(251, 191, 36, 0.3);
        }

        .recipe-rating-display .star-rating {
            width: 16px;
            height: 16px;
            cursor: default;
            font-size: 14px;
        }

        .rating-value {
            font-size: 0.875rem;
            font-weight: 600;
            color: #f59e0b;
        }

        /* Responsive adjustments */
        @media (max-width: 768px) {
            .recipe-content {
                grid-template-columns: 1fr;
            }

            .input-section {
                flex-direction: column;
            }

            .recipe-header {
                flex-direction: column;
                gap: 0.5rem;
            }

            .instruction-content {
                flex-direction: column;
                align-items: flex-start;
                gap: 0.5rem;
            }

            .timer-btn {
                align-self: flex-end;
            }

            .servings-controls {
                margin-left: 0;
                margin-top: 0.5rem;
            }

            .notes-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 1rem;
            }

            .rating-container {
                width: 100%;
            }

            .notes-actions {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginView" class="login-container">
        <div class="login-card">
            <h1 class="login-title">Login</h1>

            <div id="errorMessage" class="error-message hidden"></div>

            <form class="login-form" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <input type="email" id="loginEmail" class="form-input" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="loginPassword" class="form-input" placeholder="Password" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>

            <div class="divider">Or...</div>

            <div class="register-link">
                Don't have an account? <a href="#" onclick="showRegister()">Register</a>
            </div>

            <a href="#" class="guest-link" onclick="continueAsGuest()">
                Continue as Guest →
            </a>
        </div>
    </div>

    <!-- Register Page -->
    <div id="registerView" class="login-container hidden">
        <div class="login-card">
            <h1 class="login-title">Register</h1>

            <div id="registerErrorMessage" class="error-message hidden"></div>

            <form class="login-form" onsubmit="handleRegister(event)">
                <div class="form-group">
                    <input type="text" id="registerName" class="form-input" placeholder="Full Name" required>
                </div>
                <div class="form-group">
                    <input type="email" id="registerEmail" class="form-input" placeholder="Email" required>
                </div>
                <div class="form-group">
                    <input type="password" id="registerPassword" class="form-input" placeholder="Password" required>
                </div>
                <div class="form-group">
                    <input type="password" id="confirmPassword" class="form-input" placeholder="Confirm Password" required>
                </div>
                <button type="submit" class="login-btn">Register</button>
            </form>

            <div class="divider">Or...</div>

            <div class="register-link">
                Already have an account? <a href="#" onclick="showLogin()">Login</a>
            </div>

            <a href="#" class="guest-link" onclick="continueAsGuest()">
                Continue as Guest →
            </a>
        </div>
    </div>

    <!-- Main Recipe App -->
    <div id="mainApp" class="container hidden">
        <div id="mainView">
            <!-- Theme Toggle Button -->
            <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                <span id="themeIcon">🌙</span>
            </button>

            <div class="header">
                <div class="header-title">
                    <i data-lucide="chef-hat" style="width: 40px; height: 40px; color: #f97316;"></i>
                    <h1>ImprovEats Recipe Finder</h1>
                </div>
                <div id="userInfo" class="user-info hidden"></div>
                <div id="streakDisplay" class="streak-display hidden">
                    <div class="streak-icon">🔥</div>
                    <div class="streak-info">
                        <div class="streak-number" id="streakNumber">0</div>
                        <div class="streak-label">Day Streak</div>
                    </div>
                </div>
                <p class="header-subtitle">Enter your ingredients and discover delicious recipes you can make!</p>
            </div>

            <div class="card">
                <div class="input-section">
                    <div class="input-wrapper">
                        <i data-lucide="search"></i>
                        <input 
                            type="text" 
                            id="ingredientInput" 
                            class="input-field" 
                            placeholder="Add an ingredient (e.g., chicken, tomatoes, cheese)"
                        >
                    </div>
                    <button class="add-btn" onclick="addIngredient()">
                        <i data-lucide="plus"></i>
                        Add
                    </button>
                </div>

                <div id="ingredientsSection" class="hidden">
                    <h3>Your Ingredients:</h3>
                    <div id="ingredientsList" class="ingredients-list"></div>
                    
                    <div class="ai-generate-section">
                        <div class="ai-generate-text">✨ Let AI create a custom recipe with your ingredients!</div>
                        <button id="aiGenerateBtn" class="ai-generate-btn" onclick="generateAIRecipe()">
                            <span id="aiGenerateText">🤖 Generate AI Recipe</span>
                        </button>
                    </div>
                </div>
            </div>

            <div>
                <div class="tabs-container">
                    <button class="tab-btn active" onclick="showAllRecipes()">All Recipes</button>
                    <button class="tab-btn" onclick="showSavedRecipes()">Saved Recipes</button>
                    <button class="tab-btn" onclick="showHistory()">History</button>
                    <button class="tab-btn" onclick="showAchievements()">Achievements</button>
                </div>
                <h2 id="recipesHeader" class="recipes-header">All Recipes</h2>
                <div id="recipesList"></div>
            </div>
        </div>

        <div id="recipeDetailView" class="hidden">
            <button class="back-btn" onclick="showMainView()">
                ← Back to recipes
            </button>

            <div class="card recipe-detail">
                <div class="recipe-detail-header">
                    <div>
                        <h1 id="detailTitle" class="recipe-detail-title"></h1>
                        <div id="detailMeta" class="recipe-detail-meta"></div>
                    </div>
                    <div class="detail-actions">
                        <div id="detailMatch" class="match-score"></div>
                    </div>
                </div>

                <div class="recipe-content">
                    <div class="ingredients-section">
                        <h3>Ingredients</h3>
                        <div id="detailIngredients"></div>
                    </div>

                    <div class="instructions-section">
                        <h3>Instructions</h3>
                        <ol id="detailInstructions" class="instructions-list"></ol>
                    </div>
                </div>

                <div class="notes-section">
                    <div class="notes-header">
                        <h3 class="notes-title">Personal Notes & Rating</h3>
                        <div class="rating-container">
                            <span>Your Rating:</span>
                            <div class="rating-stars" id="ratingStars"></div>
                            <span class="rating-text" id="ratingText">Not rated</span>
                        </div>
                    </div>
                    
                    <div id="existingNotes" class="existing-notes hidden">
                        <div class="existing-notes-text" id="existingNotesText"></div>
                    </div>
                    
                    <textarea 
                        id="notesInput" 
                        class="notes-input" 
                        placeholder="Add your personal notes about this recipe... (cooking tips, modifications, thoughts, etc.)"
                    ></textarea>
                    
                    <div class="notes-actions">
                        <button onclick="saveRecipeNotes()" class="save-notes-btn">Save Notes</button>
                        <button onclick="clearRecipeNotes()" class="clear-notes-btn">Clear All</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Sample recipe database
        let recipes = [
            {
                id: 1,
                name: "Spaghetti Carbonara",
                ingredients: ["300g spaghetti", "3 eggs", "150g bacon", "100g parmesan cheese", "1 tsp black pepper"],
                servings: 4,
                instructions: [
                    "Cook spaghetti according to package directions",
                    "Fry bacon until crispy, reserve fat",
                    "Whisk eggs with parmesan and pepper",
                    "Toss hot pasta with egg mixture and bacon",
                    "Serve immediately with extra cheese"
                ],
                timers: [12, 8, 2, 3, 0],
                isAiGenerated: false
            },
            {
                id: 2,
                name: "Chicken Stir Fry",
                ingredients: ["400g chicken breast", "3 tbsp soy sauce", "2 cloves garlic", "1 inch ginger", "300g vegetables", "2 cups rice"],
                servings: 3,
                instructions: [
                    "Cut chicken into bite-sized pieces",
                    "Heat oil in wok or large pan",
                    "Cook chicken until golden",
                    "Add garlic, ginger, and vegetables",
                    "Stir in soy sauce and serve over rice"
                ],
                timers: [5, 2, 6, 5, 2],
                isAiGenerated: false
            },
            {
                id: 3,
                name: "Tomato Basil Pasta",
                ingredients: ["300g pasta", "4 tomatoes", "1/4 cup basil", "3 cloves garlic", "3 tbsp olive oil", "50g parmesan cheese"],
                servings: 4,
                instructions: [
                    "Cook pasta according to package directions",
                    "Sauté garlic in olive oil",
                    "Add tomatoes and simmer",
                    "Toss with pasta and fresh basil",
                    "Top with parmesan cheese"
                ],
                timers: [10, 3, 8, 2, 0],
                isAiGenerated: false
            },
            {
                id: 4,
                name: "Scrambled Eggs",
                ingredients: ["4 eggs", "2 tbsp butter", "1/2 tsp salt", "1/4 tsp pepper"],
                servings: 2,
                instructions: [
                    "Beat eggs with salt and pepper",
                    "Heat butter in non-stick pan",
                    "Pour in eggs and gently scramble",
                    "Remove from heat while slightly wet",
                    "Serve immediately"
                ],
                timers: [1, 1, 3, 0, 0],
                isAiGenerated: false
            },
            {
                id: 5,
                name: "Chicken Caesar Salad",
                ingredients: ["300g chicken breast", "1 head lettuce", "50g parmesan cheese", "1 cup croutons", "1/4 cup caesar dressing"],
                servings: 2,
                instructions: [
                    "Grill or pan-fry chicken breast",
                    "Chop lettuce and place in bowl",
                    "Slice chicken and add to salad",
                    "Add croutons and parmesan",
                    "Toss with caesar dressing"
                ],
                timers: [8, 2, 0, 0, 0],
                isAiGenerated: false
            },
            {
                id: 6,
                name: "Vegetable Soup",
                ingredients: ["400g vegetables", "1L broth", "1 onion", "3 cloves garlic", "2 tsp herbs"],
                servings: 6,
                instructions: [
                    "Sauté onion and garlic",
                    "Add chopped vegetables",
                    "Pour in broth and bring to boil",
                    "Simmer until vegetables are tender",
                    "Season with herbs and serve"
                ],
                timers: [5, 3, 5, 15, 2],
                isAiGenerated: false
            },
            {
                id: 7,
                name: "Grilled Cheese Sandwich",
                ingredients: ["2 slices bread", "2 slices cheese", "1 tbsp butter"],
                servings: 1,
                instructions: [
                    "Butter one side of each bread slice",
                    "Place cheese between unbuttered sides",
                    "Heat pan over medium heat",
                    "Cook sandwich until golden on both sides",
                    "Slice and serve hot"
                ],
                timers: [1, 0, 2, 4, 1],
                isAiGenerated: false
            }
        ];

        let nextRecipeId = 8;
        let isGeneratingRecipe = false;

        let userIngredients = [];
        let currentRecipe = null;
        let currentUser = null;
        let savedRecipes = [];
        let cookingHistory = [];
        let currentTab = 'all';
        let currentServings = 1;
        let activeTimers = {};
        let timerIntervals = {};
        let recipeNotes = {}; // Store user notes and ratings for recipes
        let achievements = [
            {
                id: 'first_recipe',
                name: 'First Steps',
                description: 'Cook your first recipe',
                icon: '👶',
                completed: false,
                progress: 0,
                maxProgress: 1
            },
            {
                id: 'recipe_master',
                name: 'Recipe Master',
                description: 'Cook 5 different recipes',
                icon: '👨‍🍳',
                completed: false,
                progress: 0,
                maxProgress: 5
            },
            {
                id: 'ingredient_explorer',
                name: 'Ingredient Explorer',
                description: 'Add 10 different ingredients',
                icon: '🥕',
                completed: false,
                progress: 0,
                maxProgress: 10
            },
            {
                id: 'star_collector',
                name: 'Star Collector',
                description: 'Save 3 recipes to favorites',
                icon: '⭐',
                completed: false,
                progress: 0,
                maxProgress: 3
            },
            {
                id: 'speed_cook',
                name: 'Speed Cook',
                description: 'Cook 3 recipes under 10 minutes',
                icon: '⚡',
                completed: false,
                progress: 0,
                maxProgress: 3
            },
            {
                id: 'pasta_lover',
                name: 'Pasta Lover',
                description: 'Cook 2 pasta recipes',
                icon: '🍝',
                completed: false,
                progress: 0,
                maxProgress: 2
            },
            {
                id: 'healthy_eater',
                name: 'Healthy Eater',
                description: 'Cook a salad recipe',
                icon: '🥗',
                completed: false,
                progress: 0,
                maxProgress: 1
            },
            {
                id: 'cooking_streak',
                name: 'Cooking Streak',
                description: 'Cook recipes on 3 different days',
                icon: '🔥',
                completed: false,
                progress: 0,
                maxProgress: 3
            }
        ];

        // Authentication functions
        function showLogin() {
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('registerView').classList.add('hidden');
        }

        function showRegister() {
            document.getElementById('registerView').classList.remove('hidden');
            document.getElementById('loginView').classList.add('hidden');
        }

        function handleLogin(event) {
            event.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (email && password) {
                currentUser = {
                    name: email.split('@')[0],
                    email: email,
                    loginType: 'email'
                };
                showMainApp();
            } else {
                showError('errorMessage', 'Please enter valid credentials');
            }
        }

        function handleRegister(event) {
            event.preventDefault();
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (password !== confirmPassword) {
                showError('registerErrorMessage', 'Passwords do not match');
                return;
            }

            if (name && email && password) {
                currentUser = {
                    name: name,
                    email: email,
                    loginType: 'email'
                };
                showMainApp();
            } else {
                showError('registerErrorMessage', 'Please fill in all fields');
            }
        }

        function continueAsGuest() {
            currentUser = {
                name: 'Guest',
                email: null,
                loginType: 'guest'
            };
            showMainApp();
        }

        function logout() {
            currentUser = null;
            document.getElementById('mainApp').classList.add('hidden');
            document.getElementById('loginView').classList.remove('hidden');
            document.getElementById('registerView').classList.add('hidden');

            userIngredients = [];
            currentRecipe = null;
            savedRecipes = [];
            cookingHistory = [];
            currentTab = 'all';
            showMainView();
        }

        function showError(elementId, message) {
            const errorElement = document.getElementById(elementId);
            errorElement.textContent = message;
            errorElement.classList.remove('hidden');
            setTimeout(() => {
                errorElement.classList.add('hidden');
            }, 5000);
        }

        function showMainApp() {
            document.getElementById('loginView').classList.add('hidden');
            document.getElementById('registerView').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');

            if (currentUser && currentUser.loginType !== 'guest') {
                const userInfo = document.getElementById('userInfo');
                userInfo.innerHTML = `
                    Welcome, ${currentUser.name}!
                    <button class="logout-btn" onclick="logout()">Logout</button>
                `;
                userInfo.classList.remove('hidden');
            }

            updateDisplay();
            updateStreakDisplay();
            lucide.createIcons();
        }

        // Recipe app functions
        function addIngredient() {
            const input = document.getElementById('ingredientInput');
            const ingredient = input.value.trim().toLowerCase();

            if (ingredient && !userIngredients.includes(ingredient)) {
                userIngredients.push(ingredient);
                input.value = '';
                checkAchievements();
                updateDisplay();
            }
        }

        function removeIngredient(ingredient) {
            userIngredients = userIngredients.filter(item => item !== ingredient);
            updateDisplay();
        }

        function toggleSaveRecipe(recipeId, event) {
            event.stopPropagation();

            if (savedRecipes.includes(recipeId)) {
                savedRecipes = savedRecipes.filter(id => id !== recipeId);
            } else {
                savedRecipes.push(recipeId);
            }

            checkAchievements();
            updateDisplay();
        }

        function showAllRecipes() {
            currentTab = 'all';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateDisplay();
        }

        function showSavedRecipes() {
            currentTab = 'saved';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateDisplay();
        }

        function showHistory() {
            currentTab = 'history';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateDisplay();
        }

        function showAchievements() {
            currentTab = 'achievements';
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            updateDisplay();
        }

        function showRecipeDetail(recipeId) {
            const matchingRecipes = getMatchingRecipes();
            const allRecipes = userIngredients.length > 0 ? matchingRecipes : recipes;
            const recipe = allRecipes.find(r => r.id === recipeId) || recipes.find(r => r.id === recipeId);

            if (!recipe) return;

            currentRecipe = recipe;
            currentServings = recipe.servings;
            document.getElementById('mainView').classList.add('hidden');
            document.getElementById('recipeDetailView').classList.remove('hidden');

            const titleElement = document.getElementById('detailTitle');
            titleElement.innerHTML = recipe.name + (recipe.isAiGenerated ? ' <span class="ai-recipe-badge">🤖 AI Generated</span>' : '');

            const isFromHistory = currentTab === 'history';
            const actionButton = isFromHistory ? 
                `<button class="remove-history-btn" onclick="removeFromHistory(${recipe.id})">
                    <i data-lucide="trash-2"></i>
                    Remove from History
                </button>` :
                `<button class="finish-cooking-btn" onclick="finishCooking(${recipe.id})">
                    <i data-lucide="check-circle"></i>
                    Finish Cooking
                </button>`;

            const userNote = recipeNotes[recipe.id];
            const ratingDisplay = userNote && userNote.rating ? `
                <div class="recipe-rating-display">
                    ${Array.from({length: 5}, (_, i) => 
                        `<div class="star-rating ${i < userNote.rating ? 'filled' : ''}">★</div>`
                    ).join('')}
                    <span class="rating-value">${userNote.rating}/5</span>
                </div>
            ` : '';

            const metaHtml = `
                <div class="meta-item">
                    <i data-lucide="users"></i>
                    <span id="servingsDisplay">${currentServings} servings</span>
                </div>
                <div class="servings-controls">
                    <button onclick="updateServings(-1)" class="serving-btn">-</button>
                    <button onclick="updateServings(1)" class="serving-btn">+</button>
                </div>
                ${ratingDisplay}
                <button onclick="exportRecipe(currentRecipe)" class="export-btn">
                    <i data-lucide="download"></i>
                    Export Recipe
                </button>
                ${actionButton}
            `;
            document.getElementById('detailMeta').innerHTML = metaHtml;

            if (userIngredients.length > 0) {
                const matchHtml = `
                    <div class="match-percentage">${Math.round(recipe.matchPercentage)}%</div>
                    <div class="match-label">match</div>
                `;
                document.getElementById('detailMatch').innerHTML = matchHtml;
            } else {
                document.getElementById('detailMatch').innerHTML = '';
            }

            updateRecipeIngredients();
            updateRecipeInstructions();
            initializeNotesSection();

            lucide.createIcons();
        }

        function finishCooking(recipeId) {
            const recipe = recipes.find(r => r.id === recipeId);
            if (recipe) {
                cookingHistory.push({ recipe: recipe, cookedDate: new Date() });
                checkAchievements();
                alert(`Recipe "${recipe.name}" added to history!`);
            }
        }

        function calculateCookingStreak() {
            if (cookingHistory.length === 0) return 0;

            const cookingDates = cookingHistory.map(entry => {
                const date = new Date(entry.cookedDate);
                return new Date(date.getFullYear(), date.getMonth(), date.getDate());
            }).sort((a, b) => b - a);

            const uniqueDates = [...new Set(cookingDates.map(date => date.getTime()))]
                .map(time => new Date(time))
                .sort((a, b) => b - a);

            if (uniqueDates.length === 0) return 0;

            const today = new Date();
            const todayDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());
            const yesterday = new Date(todayDate);
            yesterday.setDate(yesterday.getDate() - 1);

            let streak = 0;
            let currentDate = todayDate;

            // Check if we cooked today or yesterday to start the streak
            if (uniqueDates[0].getTime() === todayDate.getTime()) {
                streak = 1;
                currentDate = todayDate;
            } else if (uniqueDates[0].getTime() === yesterday.getTime()) {
                streak = 1;
                currentDate = yesterday;
            } else {
                return 0; // No recent cooking, streak is broken
            }

            // Count consecutive days
            for (let i = 1; i < uniqueDates.length; i++) {
                const expectedDate = new Date(currentDate);
                expectedDate.setDate(expectedDate.getDate() - 1);
                
                if (uniqueDates[i].getTime() === expectedDate.getTime()) {
                    streak++;
                    currentDate = expectedDate;
                } else {
                    break;
                }
            }

            return streak;
        }

        function updateStreakDisplay() {
            const streak = calculateCookingStreak();
            const streakDisplay = document.getElementById('streakDisplay');
            const streakNumber = document.getElementById('streakNumber');
            
            if (cookingHistory.length > 0) {
                streakDisplay.classList.remove('hidden');
                streakNumber.textContent = streak;
            } else {
                streakDisplay.classList.add('hidden');
            }
        }

        function checkAchievements() {
            const uniqueIngredients = new Set();
            userIngredients.forEach(ing => uniqueIngredients.add(ing));
            
            const uniqueRecipesCooked = new Set();
            const cookingDates = new Set();
            const fastRecipes = [];
            const pastaRecipes = [];
            const saladRecipes = [];

            cookingHistory.forEach(entry => {
                uniqueRecipesCooked.add(entry.recipe.id);
                cookingDates.add(entry.cookedDate.toDateString());
                
                if (entry.recipe.name.toLowerCase().includes('pasta') || entry.recipe.name.toLowerCase().includes('spaghetti')) {
                    pastaRecipes.push(entry.recipe.id);
                }
                
                if (entry.recipe.name.toLowerCase().includes('salad')) {
                    saladRecipes.push(entry.recipe.id);
                }
            });

            // Update achievements
            updateAchievement('first_recipe', Math.min(cookingHistory.length, 1));
            updateAchievement('recipe_master', Math.min(uniqueRecipesCooked.size, 5));
            updateAchievement('ingredient_explorer', Math.min(uniqueIngredients.size, 10));
            updateAchievement('star_collector', Math.min(savedRecipes.length, 3));
            updateAchievement('pasta_lover', Math.min(pastaRecipes.length, 2));
            updateAchievement('healthy_eater', Math.min(saladRecipes.length, 1));
            updateAchievement('cooking_streak', Math.min(cookingDates.size, 3));
            
            updateStreakDisplay();
        }

        function updateAchievement(achievementId, newProgress) {
            const achievement = achievements.find(a => a.id === achievementId);
            if (achievement && !achievement.completed) {
                achievement.progress = newProgress;
                if (achievement.progress >= achievement.maxProgress) {
                    achievement.completed = true;
                    showAchievementNotification(achievement);
                }
            }
        }

        function showAchievementNotification(achievement) {
            alert(`🎉 Achievement Unlocked: ${achievement.name}! ${achievement.icon}`);
        }

        function removeFromHistory(recipeId) {
            const recipeIndex = cookingHistory.findIndex(entry => entry.recipe.id === recipeId);
            if (recipeIndex !== -1) {
                const recipeName = cookingHistory[recipeIndex].recipe.name;
                cookingHistory.splice(recipeIndex, 1);
                checkAchievements();
                alert(`Recipe "${recipeName}" removed from history!`);
                showMainView();
                updateDisplay();
            }
        }

        function showMainView() {
            document.getElementById('recipeDetailView').classList.add('hidden');
            document.getElementById('mainView').classList.remove('hidden');
        }

        function getMatchingRecipes() {
            if (userIngredients.length === 0) return recipes;

            return recipes.map(recipe => {
                const matchedIngredients = recipe.ingredients.filter(recipeIngredient =>
                    userIngredients.some(userIngredient => 
                        recipeIngredient.toLowerCase().includes(userIngredient) ||
                        userIngredient.includes(recipeIngredient.toLowerCase())
                    )
                );

                const matchPercentage = (matchedIngredients.length / recipe.ingredients.length) * 100;

                return {
                    ...recipe,
                    matchedIngredients,
                    matchPercentage,
                    missingIngredients: recipe.ingredients.filter(ingredient => 
                        !matchedIngredients.includes(ingredient)
                    )
                };
            })
            .filter(recipe => recipe.matchedIngredients.length > 0)
            .sort((a, b) => b.matchPercentage - a.matchPercentage);
        }

        function updateDisplay() {
            const ingredientsSection = document.getElementById('ingredientsSection');
            const ingredientsList = document.getElementById('ingredientsList');

            if (userIngredients.length > 0) {
                ingredientsSection.classList.remove('hidden');
                ingredientsList.innerHTML = userIngredients.map(ingredient => `
                    <span class="ingredient-tag">
                        ${ingredient}
                        <button class="remove-btn" onclick="removeIngredient('${ingredient}')">
                            <i data-lucide="x" style="width: 14px; height: 14px;"></i>
                        </button>
                    </span>
                `).join('');
            } else {
                ingredientsSection.classList.add('hidden');
            }

            let recipesToShow = [];
            const recipesHeader = document.getElementById('recipesHeader');

            if (currentTab === 'saved') {
                recipesToShow = recipes.filter(recipe => savedRecipes.includes(recipe.id));
                recipesHeader.textContent = `Saved Recipes (${recipesToShow.length})`;
            } else if (currentTab === 'history') {
                recipesToShow = cookingHistory;
                recipesHeader.textContent = `Cooking History (${cookingHistory.length})`;
            } else if (currentTab === 'achievements') {
                const completedCount = achievements.filter(a => a.completed).length;
                recipesToShow = achievements;
                recipesHeader.textContent = `Achievements (${completedCount}/${achievements.length})`;
            } else {
                const matchingRecipes = getMatchingRecipes();
                recipesToShow = matchingRecipes;
                recipesHeader.textContent = userIngredients.length > 0 ? 
                    `Recipes you can make (${matchingRecipes.length})` : 'All Recipes';
            }

            const recipesList = document.getElementById('recipesList');

            if (recipesToShow.length === 0 && currentTab !== 'achievements') {
                let emptyMessage;
                if (currentTab === 'saved') {
                    emptyMessage = 'No saved recipes yet. Click the star icon on any recipe to save it!';
                } else if (currentTab === 'history') {
                    emptyMessage = 'No cooking history yet. Finish cooking a recipe to see it here!';
                } else {
                    emptyMessage = userIngredients.length > 0 ? 
                        'No recipes found with your current ingredients.' : 'No recipes available.';
                }

                recipesList.innerHTML = `
                    <div class="no-recipes">
                        <i data-lucide="chef-hat" style="width: 48px; height: 48px;"></i>
                        <p>${emptyMessage}</p>
                        ${currentTab === 'all' && userIngredients.length > 0 ? 
                            '<p class="subtitle">Try adding more ingredients or removing some to see more options.</p>' : ''}
                    </div>
                `;
            } else if (currentTab === 'achievements') {
                recipesList.innerHTML = achievements.map(achievement => {
                    const progressPercent = (achievement.progress / achievement.maxProgress) * 100;
                    const statusClass = achievement.completed ? 'completed' : (achievement.progress > 0 ? '' : 'locked');
                    
                    return `
                        <div class="achievement-card ${statusClass}">
                            <div class="achievement-header">
                                <div class="achievement-icon ${statusClass}">
                                    ${achievement.completed ? '✓' : achievement.icon}
                                </div>
                                <div class="achievement-info ${statusClass}">
                                    <h3>${achievement.name}</h3>
                                    <div class="achievement-description">${achievement.description}</div>
                                </div>
                            </div>
                            <div class="achievement-progress">
                                <div class="progress-bar">
                                    <div class="progress-fill ${statusClass}" style="width: ${progressPercent}%"></div>
                                </div>
                                <div class="progress-text">${achievement.progress}/${achievement.maxProgress}</div>
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                if (currentTab === 'history') {
                    recipesList.innerHTML = recipesToShow.map(historyEntry => {
                        const recipe = historyEntry.recipe;
                        const cookedDate = new Date(historyEntry.cookedDate);
                        const dateStr = cookedDate.toLocaleDateString('en-US', { 
                            weekday: 'long', 
                            year: 'numeric', 
                            month: 'long', 
                            day: 'numeric' 
                        });

                        return `
                            <div class="history-item" onclick="showRecipeDetail(${recipe.id})">
                                <div class="history-date">Cooked on ${dateStr}</div>
                                <div class="recipe-header">
                                    <h3 class="recipe-title">
                                        ${recipe.name}
                                        ${recipe.isAiGenerated ? '<span class="ai-recipe-badge">🤖 AI</span>' : ''}
                                    </h3>
                                </div>
                                <div class="recipe-meta">
                                    <div class="meta-item">
                                        <i data-lucide="users"></i>
                                        <span>${recipe.servings} servings</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    }).join('');
                } else {
                    recipesList.innerHTML = recipesToShow.map(recipe => {
                        const isSaved = savedRecipes.includes(recipe.id);
                        const matchScore = userIngredients.length > 0 && currentTab !== 'saved' ? `
                            <div class="match-score">
                                <div class="match-percentage">${Math.round(recipe.matchPercentage)}%</div>
                                <div class="match-label">match</div>
                            </div>
                        ` : '';

                        const ingredientInfo = userIngredients.length > 0 && currentTab !== 'saved' ? `
                            <div class="ingredients-info">
                                ${recipe.matchedIngredients && recipe.matchedIngredients.length > 0 ? `
                                    <div class="ingredient-line have-ingredients">
                                        <span class="label">Have: </span>${recipe.matchedIngredients.join(', ')}
                                    </div>
                                ` : ''}
                                ${recipe.missingIngredients && recipe.missingIngredients.length > 0 ? `
                                    <div class="ingredient-line need-ingredients">
                                        <span class="label">Need: </span>${recipe.missingIngredients.join(', ')}
                                    </div>
                                ` : ''}
                            </div>
                        ` : '';

                        return `
                            <div class="recipe-card" onclick="showRecipeDetail(${recipe.id})">
                                <button class="star-btn" onclick="toggleSaveRecipe(${recipe.id}, event)">
                                    <i data-lucide="star" class="star-icon ${isSaved ? 'starred' : ''}"></i>
                                </button>

                                <div class="recipe-header">
                                    <h3 class="recipe-title">
                                        ${recipe.name}
                                        ${recipe.isAiGenerated ? '<span class="ai-recipe-badge">🤖 AI</span>' : ''}
                                    </h3>
                                    ${matchScore}
                                </div>

                                <div class="recipe-meta">
                                    <div class="meta-item">
                                        <i data-lucide="users"></i>
                                        <span>${recipe.servings} servings</span>
                                    </div>
                                </div>

                                ${ingredientInfo}
                            </div>
                        `;
                    }).join('');
                }
            }

            lucide.createIcons();
        }

        // Event listeners
        document.getElementById('ingredientInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                addIngredient();
            }
        });

        // Theme management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme icon
            const themeIcon = document.getElementById('themeIcon');
            themeIcon.textContent = newTheme === 'dark' ? '☀️' : '🌙';
        }

         function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            const themeIcon = document.getElementById('themeIcon');
            if (themeIcon) {
                themeIcon.textContent = savedTheme === 'dark' ? '☀️' : '🌙';
            }
        }

        // Timer functions
        function startTimer(stepIndex, minutes) {
            if (!currentRecipe || !currentRecipe.timers) return;
            
            const timerId = `timer-${currentRecipe.id}-${stepIndex}`;
            
            // If timer is already running, stop it
            if (activeTimers[timerId]) {
                clearInterval(timerIntervals[timerId]);
                delete activeTimers[timerId];
                delete timerIntervals[timerId];
                updateTimerButton(stepIndex, currentRecipe.timers[stepIndex]);
                return;
            }

            let totalSeconds = minutes * 60;
            activeTimers[timerId] = totalSeconds;
            
            const interval = setInterval(() => {
                activeTimers[timerId]--;
                
                if (activeTimers[timerId] <= 0) {
                    clearInterval(interval);
                    delete activeTimers[timerId];
                    delete timerIntervals[timerId];
                    
                    // Timer done
                    updateTimerButton(stepIndex, 0, true);
                    
                    // Show notification
                    if (Notification.permission === 'granted') {
                        new Notification('Timer Done!', {
                            body: `Step ${stepIndex + 1} timer completed`,
                            icon: 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><text y=".9em" font-size="90">⏰</text></svg>'
                        });
                    } else {
                        alert(`⏰ Timer Done! Step ${stepIndex + 1} completed`);
                    }
                    
                    // Auto-reset after 5 seconds
                    setTimeout(() => {
                        updateTimerButton(stepIndex, currentRecipe.timers[stepIndex]);
                    }, 5000);
                } else {
                    updateTimerButton(stepIndex, activeTimers[timerId], false, true);
                }
            }, 1000);
            
            timerIntervals[timerId] = interval;
            updateTimerButton(stepIndex, totalSeconds, false, true);
            
            // Request notification permission
            if (Notification.permission === 'default') {
                Notification.requestPermission();
            }
        }

        function updateTimerButton(stepIndex, timeValue, isDone = false, isRunning = false) {
            const button = document.querySelector(`#timer-btn-${stepIndex}`);
            if (!button) return;
            
            if (isDone) {
                button.textContent = 'Done!';
                button.className = 'timer-btn timer-done';
            } else if (isRunning) {
                const mins = Math.floor(timeValue / 60);
                const secs = timeValue % 60;
                button.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                button.className = 'timer-btn timer-running';
            } else {
                const originalMinutes = currentRecipe && currentRecipe.timers ? currentRecipe.timers[stepIndex] : 0;
                button.textContent = originalMinutes > 0 ? `${originalMinutes}m` : 'Timer';
                button.className = 'timer-btn';
            }
        }

        // Recipe scaling functions
        function scaleRecipe(recipe, newServings) {
            const scale = newServings / recipe.servings;
            
            return {
                ...recipe,
                servings: newServings,
                scaledIngredients: recipe.ingredients.map(ingredient => {
                    // Try to extract numbers and scale them
                    const numberMatch = ingredient.match(/(\d+(?:\.\d+)?)\s*(\w+)?\s+(.*)/);
                    if (numberMatch) {
                        const [, amount, unit, name] = numberMatch;
                        const scaledAmount = (parseFloat(amount) * scale).toFixed(1).replace('.0', '');
                        return `${scaledAmount}${unit ? ' ' + unit : ''} ${name}`;
                    }
                    return ingredient;
                })
            };
        }

        function updateServings(change) {
            const newServings = Math.max(1, currentServings + change);
            currentServings = newServings;
            
            if (currentRecipe) {
                document.getElementById('servingsDisplay').textContent = `${currentServings} servings`;
                updateRecipeIngredients();
            }
        }

        // Recipe Notes & Rating Functions
        function initializeNotesSection() {
            if (!currentRecipe) return;
            
            const userNote = recipeNotes[currentRecipe.id];
            
            // Initialize rating stars
            initializeRatingStars(userNote ? userNote.rating : 0);
            
            // Load existing notes
            const notesInput = document.getElementById('notesInput');
            const existingNotes = document.getElementById('existingNotes');
            const existingNotesText = document.getElementById('existingNotesText');
            
            if (userNote && userNote.notes) {
                existingNotesText.textContent = userNote.notes;
                existingNotes.classList.remove('hidden');
                notesInput.value = userNote.notes;
            } else {
                existingNotes.classList.add('hidden');
                notesInput.value = '';
            }
        }

        function initializeRatingStars(currentRating = 0) {
            const ratingStars = document.getElementById('ratingStars');
            const ratingText = document.getElementById('ratingText');
            
            ratingStars.innerHTML = '';
            
            for (let i = 1; i <= 5; i++) {
                const star = document.createElement('div');
                star.className = `star-rating ${i <= currentRating ? 'filled' : ''}`;
                star.style.cursor = 'pointer';
                star.innerHTML = '★';
                star.onclick = () => setRating(i);
                ratingStars.appendChild(star);
            }
            
            updateRatingText(currentRating);
        }

        function setRating(rating) {
            if (!currentRecipe) return;
            
            if (!recipeNotes[currentRecipe.id]) {
                recipeNotes[currentRecipe.id] = {};
            }
            
            recipeNotes[currentRecipe.id].rating = rating;
            saveNotesToStorage();
            initializeRatingStars(rating);
            
            // Update meta display
            showRecipeDetail(currentRecipe.id);
        }

        function updateRatingText(rating) {
            const ratingText = document.getElementById('ratingText');
            if (rating === 0) {
                ratingText.textContent = 'Not rated';
            } else {
                const ratingLabels = ['', 'Poor', 'Fair', 'Good', 'Very Good', 'Excellent'];
                ratingText.textContent = `${rating}/5 - ${ratingLabels[rating]}`;
            }
        }

        function saveRecipeNotes() {
            if (!currentRecipe) return;
            
            const notesInput = document.getElementById('notesInput');
            const notes = notesInput.value.trim();
            
            if (!recipeNotes[currentRecipe.id]) {
                recipeNotes[currentRecipe.id] = {};
            }
            
            if (notes) {
                recipeNotes[currentRecipe.id].notes = notes;
                saveNotesToStorage();
                initializeNotesSection();
                alert('Notes saved successfully!');
            } else {
                alert('Please enter some notes before saving.');
            }
        }

        function clearRecipeNotes() {
            if (!currentRecipe) return;
            
            if (confirm('Are you sure you want to clear all notes and rating for this recipe?')) {
                delete recipeNotes[currentRecipe.id];
                saveNotesToStorage();
                initializeNotesSection();
                
                // Update meta display to remove rating
                showRecipeDetail(currentRecipe.id);
                
                alert('Notes and rating cleared successfully!');
            }
        }

        function saveNotesToStorage() {
            try {
                localStorage.setItem('recipeNotes', JSON.stringify(recipeNotes));
            } catch (e) {
                console.warn('Could not save notes to localStorage:', e);
            }
        }

        function loadNotesFromStorage() {
            try {
                const saved = localStorage.getItem('recipeNotes');
                if (saved) {
                    recipeNotes = JSON.parse(saved);
                }
            } catch (e) {
                console.warn('Could not load notes from localStorage:', e);
                recipeNotes = {};
            }
        }

        function updateRecipeIngredients() {
            if (!currentRecipe) return;
            
            const scaledRecipe = scaleRecipe(currentRecipe, currentServings);
            
            const ingredientsHtml = scaledRecipe.scaledIngredients.map(ingredient => {
                const isMatched = currentRecipe.matchedIngredients && 
                    currentRecipe.matchedIngredients.some(matched => ingredient.includes(matched.split(' ').pop()));
                const className = isMatched ? 'ingredient-have' : 'ingredient-need';
                const status = isMatched ? '✓ Have it' : 'Need to buy';
                return `
                    <div class="ingredient-item ${className}">
                        ${ingredient}
                        <span class="ingredient-status">${status}</span>
                    </div>
                `;
            }).join('');
            document.getElementById('detailIngredients').innerHTML = ingredientsHtml;
        }

        function updateRecipeInstructions() {
            if (!currentRecipe) return;
            
            const instructionsHtml = currentRecipe.instructions.map((instruction, index) => {
                const timerMinutes = currentRecipe.timers ? currentRecipe.timers[index] : 0;
                const timerButton = timerMinutes > 0 ? 
                    `<button id="timer-btn-${index}" class="timer-btn" onclick="startTimer(${index}, ${timerMinutes})">
                        ${timerMinutes}m
                    </button>` : '';
                
                return `
                    <li class="instruction-item">
                        <span class="instruction-number">${index + 1}</span>
                        <div class="instruction-content">
                            <span class="instruction-text">${instruction}</span>
                            ${timerButton}
                        </div>
                    </li>
                `;
            }).join('');
            document.getElementById('detailInstructions').innerHTML = instructionsHtml;
        }

        // Export recipe function
        function exportRecipe(recipe) {
            const scaledRecipe = scaleRecipe(recipe, currentServings);
            
            const recipeText = `${scaledRecipe.name}

Servings: ${scaledRecipe.servings}

Ingredients:
${scaledRecipe.scaledIngredients.map(ing => `- ${ing}`).join('\n')}

Instructions:
${scaledRecipe.instructions.map((inst, index) => `${index + 1}. ${inst}`).join('\n')}

Recipe from ImprovEats Recipe Finder`;

            const blob = new Blob([recipeText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${recipe.name.replace(/[^a-z0-9]/gi, '_').toLowerCase()}_recipe.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // AI Recipe Generation Functions
        async function generateAIRecipe() {
    if (isGeneratingRecipe || userIngredients.length === 0) return;
    isGeneratingRecipe = true;

    const btn = document.getElementById('aiGenerateBtn');
    btn.disabled = true;
    btn.innerHTML = `<span class="loading-spinner"></span> Generating...`;

    try {
        const res = await fetch('http://localhost:3000/api/generate', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ ingredients: userIngredients })
        });

        const data = await res.json();
if (!data.recipe) throw new Error(data.error || "No recipe returned");


        const newRecipe = {
            id: nextRecipeId++,
            name: "AI Recipe",
            ingredients: userIngredients.map(i => i),
            instructions: data.recipe.split('\n'),
            servings: 2,
            timers: [],
            isAiGenerated: true
        };

        recipes.unshift(newRecipe);
        updateDisplay();
    } catch (err) {
        alert("Error generating recipe.");
        console.error(err);
    }

    btn.disabled = false;
    btn.innerHTML = `🤖 Generate AI Recipe`;
    isGeneratingRecipe = false;
}

        async function createAIRecipe(ingredients) {
            // Simulate AI recipe generation with realistic delay
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            // Analyze ingredients to determine recipe type and name
            const recipeInfo = analyzeIngredientsForRecipe(ingredients);
            
            // Create ingredient list with estimated amounts
            const recipeIngredients = ingredients.map(ingredient => {
                const amounts = recipeInfo.amounts[ingredient] || getRandomAmount(ingredient);
                return `${amounts} ${ingredient}`;
            });

            // Add contextual extras based on recipe type
            if (recipeInfo.extras) {
                recipeIngredients.push(...recipeInfo.extras);
            }

            return {
                id: nextRecipeId++,
                name: recipeInfo.name,
                ingredients: recipeIngredients,
                servings: recipeInfo.servings,
                instructions: recipeInfo.instructions,
                timers: recipeInfo.timers,
                isAiGenerated: true,
                matchPercentage: 100, // AI recipes are perfect matches
                matchedIngredients: recipeIngredients,
                missingIngredients: []
            };
        }

        function analyzeIngredientsForRecipe(ingredients) {
            const dessertIngredients = ['sugar', 'cocoa powder', 'chocolate', 'honey', 'vanilla', 'butter', 'cream', 'hazelnut', 'nuts', 'almonds', 'cacao', 'syrup', 'jam'];
            const proteinIngredients = ['chicken', 'beef', 'pork', 'fish', 'turkey', 'eggs', 'tofu', 'beans', 'lentils', 'shrimp', 'salmon', 'tuna', 'bacon', 'ham'];
            const vegetableIngredients = ['tomato', 'onion', 'garlic', 'carrot', 'broccoli', 'spinach', 'pepper', 'mushroom', 'lettuce', 'cucumber', 'cabbage', 'celery', 'potato', 'corn', 'peas', 'beans', 'zucchini', 'eggplant', 'asparagus'];
            const pastaIngredients = ['pasta', 'spaghetti', 'noodles', 'macaroni', 'linguine', 'penne', 'fettuccine'];
            const riceIngredients = ['rice', 'quinoa', 'barley', 'bulgur', 'couscous'];
            const breadIngredients = ['wheat', 'flour', 'bread', 'yeast', 'baking powder', 'dough'];
            const saladIngredients = ['lettuce', 'cucumber', 'tomato', 'carrot', 'spinach', 'arugula', 'kale', 'cabbage', 'radish'];
            const fruitIngredients = ['apple', 'banana', 'orange', 'berries', 'strawberry', 'blueberry', 'grape', 'lemon', 'lime', 'avocado'];
            const spiceIngredients = ['salt', 'pepper', 'herbs', 'basil', 'oregano', 'thyme', 'rosemary', 'paprika', 'cumin', 'ginger', 'turmeric', 'cinnamon'];

            // Check for different categories
            const hasDesert = ingredients.some(ing => dessertIngredients.some(d => ing.toLowerCase().includes(d))) && 
                            !ingredients.some(ing => vegetableIngredients.some(v => ing.toLowerCase().includes(v)) && 
                            !['tomato'].some(t => ing.toLowerCase().includes(t)));
            const hasProtein = ingredients.some(ing => proteinIngredients.some(p => ing.toLowerCase().includes(p)));
            const hasVegetables = ingredients.some(ing => vegetableIngredients.some(v => ing.toLowerCase().includes(v)));
            const hasPasta = ingredients.some(ing => pastaIngredients.some(p => ing.toLowerCase().includes(p)));
            const hasRice = ingredients.some(ing => riceIngredients.some(r => ing.toLowerCase().includes(r)));
            const hasBread = ingredients.some(ing => breadIngredients.some(b => ing.toLowerCase().includes(b)));
            const hasSalad = ingredients.some(ing => saladIngredients.some(s => ing.toLowerCase().includes(s)));
            const hasFruit = ingredients.some(ing => fruitIngredients.some(f => ing.toLowerCase().includes(f)));

            // Determine recipe type and generate appropriate name and instructions
            // Priority order: dessert, pasta, rice, bread, salad, main dish, vegetable, fruit, simple
            if (hasDesert) {
                return generateDessertRecipe(ingredients);
            } else if (hasPasta) {
                return generatePastaRecipe(ingredients);
            } else if (hasRice) {
                return generateRiceRecipe(ingredients);
            } else if (hasBread && !hasVegetables) {
                return generateBreadRecipe(ingredients);
            } else if (hasSalad && !hasProtein && !hasPasta && !hasRice) {
                return generateSaladRecipe(ingredients);
            } else if (hasProtein && hasVegetables) {
                return generateMainDishRecipe(ingredients);
            } else if (hasVegetables) {
                return generateVegetableRecipe(ingredients);
            } else if (hasFruit) {
                return generateFruitRecipe(ingredients);
            } else {
                // Always generate something - universal recipe
                return generateUniversalRecipe(ingredients);
            }
        }

        function generateDessertRecipe(ingredients) {
            const hasHazelnut = ingredients.some(ing => ing.toLowerCase().includes('hazelnut'));
            const hasChocolate = ingredients.some(ing => ing.toLowerCase().includes('chocolate') || ing.toLowerCase().includes('cocoa'));
            const hasHoney = ingredients.some(ing => ing.toLowerCase().includes('honey'));
            const hasSugar = ingredients.some(ing => ing.toLowerCase().includes('sugar'));
            const hasCocoaPowder = ingredients.some(ing => ing.toLowerCase().includes('cocoa powder'));
            
            let recipeName;
            if (hasHazelnut && hasChocolate) {
                recipeName = "Chocolate Hazelnut Brownies";
            } else if (hasHazelnut && hasHoney) {
                recipeName = "Honey Hazelnut Cookies";
            } else if (hasHazelnut) {
                recipeName = "Hazelnut Energy Balls";
            } else if (hasChocolate && hasHoney) {
                recipeName = "Honey Chocolate Treats";
            } else if (hasChocolate || hasCocoaPowder) {
                recipeName = "Chocolate Brownies";
            } else {
                recipeName = "Sweet Homemade Treats";
            }
            
            // Generate instructions based on actual ingredients
            const instructions = [];
            const userIngredientList = ingredients.map(ing => ing.toLowerCase());
            
            if (hasCocoaPowder || hasChocolate) {
                instructions.push("Preheat oven to 350°F (175°C) and grease a baking pan");
                
                if (hasCocoaPowder) {
                    instructions.push("In a bowl, sift together the cocoa powder with flour and salt");
                }
                
                if (hasSugar) {
                    instructions.push("In another bowl, cream the sugar with butter until fluffy");
                } else {
                    instructions.push("In another bowl, mix the wet ingredients together");
                }
                
                if (hasHoney) {
                    instructions.push("Beat in the honey gradually until well combined");
                }
                
                instructions.push("Gradually mix the dry ingredients into the wet mixture");
                
                if (hasHazelnut) {
                    instructions.push("Fold in the chopped hazelnuts, distributing evenly throughout");
                }
                
                instructions.push("Pour into prepared pan and bake for 20-25 minutes until set");
            } else {
                // No-bake recipe
                instructions.push("In a large bowl, roughly chop the hazelnuts into small pieces");
                
                if (hasHoney) {
                    instructions.push("Warm the honey slightly to make it easier to mix");
                    instructions.push("Combine the chopped hazelnuts with the warm honey");
                }
                
                if (hasSugar) {
                    instructions.push("Gradually add the sugar, mixing until well combined");
                }
                
                instructions.push("Mix all ingredients together until they hold together when pressed");
                instructions.push("Roll into small balls and place on a tray");
                instructions.push("Chill in refrigerator for 30 minutes until firm");
            }
            
            return {
                name: recipeName,
                servings: 4,
                amounts: {
                    'hazelnut': '1 cup chopped',
                    'hazelnuts': '1 cup chopped',
                    'honey': '3 tbsp',
                    'sugar': '1/2 cup',
                    'cocoa powder': '1/4 cup',
                    'chocolate': '100g chopped',
                    'butter': '1/4 cup softened',
                    'flour': '1 cup',
                    'eggs': '2 large'
                },
                instructions: instructions,
                timers: new Array(instructions.length).fill(0).map((_, i) => {
                    if (instructions[i].includes('bake')) return 22;
                    if (instructions[i].includes('cream') || instructions[i].includes('beat')) return 3;
                    if (instructions[i].includes('chill')) return 30;
                    return 2;
                }),
                extras: hasCocoaPowder ? ['1/2 tsp salt'] : []
            };
        }

        function generatePastaRecipe(ingredients) {
            const pastaType = ingredients.find(ing => 
                ['pasta', 'spaghetti', 'noodles', 'macaroni'].some(p => ing.toLowerCase().includes(p))
            ) || 'pasta';
            
            const hasChicken = ingredients.some(ing => ing.toLowerCase().includes('chicken'));
            const hasTomato = ingredients.some(ing => ing.toLowerCase().includes('tomato'));
            const hasCheese = ingredients.some(ing => ing.toLowerCase().includes('cheese'));
            const hasGarlic = ingredients.some(ing => ing.toLowerCase().includes('garlic'));
            const hasOnion = ingredients.some(ing => ing.toLowerCase().includes('onion'));
            
            let recipeName;
            if (hasChicken && hasTomato) {
                recipeName = `Chicken Tomato ${capitalizeFirst(pastaType)}`;
            } else if (hasTomato && hasCheese) {
                recipeName = `Tomato Cheese ${capitalizeFirst(pastaType)}`;
            } else if (hasChicken) {
                recipeName = `Chicken ${capitalizeFirst(pastaType)}`;
            } else {
                recipeName = `Simple ${capitalizeFirst(pastaType)} Dish`;
            }
            
            // Generate instructions based on actual ingredients
            const instructions = [];
            instructions.push(`Bring a large pot of salted water to boil and cook the ${pastaType} until al dente`);
            instructions.push("Heat olive oil in a large skillet over medium heat");
            
            if (hasGarlic && hasOnion) {
                instructions.push("Add minced garlic and diced onion, sauté until fragrant and golden");
            } else if (hasGarlic) {
                instructions.push("Add minced garlic and sauté until fragrant");
            } else if (hasOnion) {
                instructions.push("Add diced onion and cook until softened");
            }
            
            if (hasChicken) {
                instructions.push("Add chicken pieces and cook until golden brown and cooked through");
            }
            
            if (hasTomato) {
                instructions.push("Add diced tomatoes and cook until they break down into a sauce");
            }
            
            instructions.push("Drain the pasta and add it to the skillet");
            
            if (hasCheese) {
                instructions.push("Remove from heat, add grated cheese and toss until melted");
            } else {
                instructions.push("Toss everything together until well combined");
            }
            
            instructions.push("Season with salt and pepper, serve immediately while hot");
            
            return {
                name: recipeName,
                servings: 3,
                amounts: {
                    'pasta': '300g',
                    'spaghetti': '300g',
                    'noodles': '300g',
                    'tomato': '4 medium diced',
                    'tomatoes': '4 medium diced',
                    'garlic': '3 cloves minced',
                    'onion': '1 medium diced',
                    'cheese': '1/2 cup grated',
                    'chicken': '300g cubed'
                },
                instructions: instructions,
                timers: new Array(instructions.length).fill(0).map((_, i) => {
                    if (instructions[i].includes('boil') || instructions[i].includes('cook')) return 8;
                    if (instructions[i].includes('sauté') || instructions[i].includes('brown')) return 4;
                    return 2;
                }),
                extras: ['3 tbsp olive oil', 'salt and pepper to taste']
            };
        }

        function generateRiceRecipe(ingredients) {
            return {
                name: `Savory Rice Bowl with Fresh Ingredients`,
                servings: 4,
                amounts: {
                    'rice': '2 cups',
                    'chicken': '400g diced',
                    'vegetables': '2 cups mixed',
                    'onion': '1 medium diced',
                    'garlic': '2 cloves minced',
                    'soy sauce': '3 tbsp'
                },
                instructions: [
                    "Cook rice according to package directions",
                    "Heat oil in a large wok or pan",
                    "Cook protein until golden brown",
                    "Add vegetables and stir-fry until crisp-tender",
                    "Add cooked rice and seasonings",
                    "Stir everything together and serve immediately"
                ],
                timers: [18, 2, 6, 5, 3, 1],
                extras: ['2 tbsp vegetable oil', 'salt to taste']
            };
        }

        function generateMainDishRecipe(ingredients) {
            const protein = ingredients.find(ing => 
                ['chicken', 'beef', 'pork', 'fish'].some(p => ing.toLowerCase().includes(p))
            ) || 'protein';
            
            const hasGarlic = ingredients.some(ing => ing.toLowerCase().includes('garlic'));
            const hasOnion = ingredients.some(ing => ing.toLowerCase().includes('onion'));
            const hasVegetables = ingredients.some(ing => 
                ['tomato', 'carrot', 'broccoli', 'pepper', 'mushroom', 'vegetables'].some(v => ing.toLowerCase().includes(v))
            );
            const hasHerbs = ingredients.some(ing => ing.toLowerCase().includes('herb') || ing.toLowerCase().includes('basil'));
            
            let recipeName;
            if (hasGarlic) {
                recipeName = `Garlic ${capitalizeFirst(protein)} Skillet`;
            } else if (hasVegetables) {
                recipeName = `${capitalizeFirst(protein)} with Vegetables`;
            } else {
                recipeName = `Pan-Seared ${capitalizeFirst(protein)}`;
            }
            
            // Generate instructions based on actual ingredients
            const instructions = [];
            instructions.push(`Pat the ${protein} dry and season with salt and pepper`);
            instructions.push("Heat olive oil in a large skillet over medium-high heat");
            instructions.push(`Add the ${protein} and cook until golden brown and cooked through`);
            instructions.push(`Remove ${protein} from pan and set aside on a plate`);
            
            if (hasOnion) {
                instructions.push("Add sliced onion to the same pan and cook until softened");
            }
            
            if (hasGarlic) {
                instructions.push("Add minced garlic and cook for 30 seconds until fragrant");
            }
            
            if (hasVegetables) {
                instructions.push("Add the vegetables to the pan and cook until tender-crisp");
            }
            
            instructions.push(`Return the ${protein} to the pan and toss everything together`);
            instructions.push("Serve immediately while hot");
            
            return {
                name: recipeName,
                servings: 3,
                amounts: {
                    'chicken': '500g',
                    'beef': '500g',
                    'pork': '500g',
                    'fish': '400g',
                    'vegetables': '3 cups chopped',
                    'onion': '1 large sliced',
                    'garlic': '3 cloves minced',
                    'tomato': '2 large diced',
                    'carrot': '2 medium sliced',
                    'broccoli': '2 cups florets',
                    'pepper': '2 medium sliced',
                    'mushroom': '200g sliced'
                },
                instructions: instructions,
                timers: new Array(instructions.length).fill(0).map((_, i) => {
                    if (instructions[i].includes('cook until golden') || instructions[i].includes('cooked through')) return 8;
                    if (instructions[i].includes('cook until tender') || instructions[i].includes('softened')) return 5;
                    if (instructions[i].includes('fragrant')) return 1;
                    return 2;
                }),
                extras: ['2 tbsp olive oil', 'salt and pepper to taste']
            };
        }

        function generateSaladRecipe(ingredients) {
            const hasLettuce = ingredients.some(ing => ing.toLowerCase().includes('lettuce'));
            const hasTomato = ingredients.some(ing => ing.toLowerCase().includes('tomato'));
            const hasCucumber = ingredients.some(ing => ing.toLowerCase().includes('cucumber'));
            const hasCarrot = ingredients.some(ing => ing.toLowerCase().includes('carrot'));
            
            let recipeName;
            if (hasLettuce && hasTomato && hasCucumber) {
                recipeName = "Fresh Garden Salad";
            } else if (hasLettuce && hasTomato) {
                recipeName = "Simple Lettuce Tomato Salad";
            } else if (hasLettuce) {
                recipeName = "Crisp Lettuce Salad";
            } else {
                recipeName = "Mixed Fresh Salad";
            }
            
            const instructions = [];
            instructions.push("Wash all fresh ingredients thoroughly under cold water");
            
            // Only add instructions for ingredients the user actually has
            if (hasLettuce) {
                instructions.push("Pat dry the lettuce leaves and tear into bite-sized pieces");
            }
            
            if (hasTomato) {
                instructions.push("Cut the tomatoes into wedges or slices");
            }
            
            if (hasCucumber) {
                instructions.push("Slice the cucumber into thin rounds");
            }
            
            if (hasCarrot) {
                instructions.push("Grate or julienne the carrots");
            }
            
            // Add generic instructions for any other ingredients
            const otherIngredients = ingredients.filter(ing => 
                !['lettuce', 'tomato', 'tomatoes', 'cucumber', 'carrot', 'carrots'].some(known => 
                    ing.toLowerCase().includes(known)
                )
            );
            
            if (otherIngredients.length > 0) {
                instructions.push(`Prepare the ${otherIngredients.join(', ')} by chopping or slicing as desired`);
            }
            
            instructions.push("Combine all prepared ingredients in a large salad bowl");
            instructions.push("Drizzle with olive oil and vinegar, season with salt and pepper");
            instructions.push("Toss gently and serve immediately while fresh");
            
            return {
                name: recipeName,
                servings: 3,
                amounts: {
                    'lettuce': '1 large head',
                    'tomato': '2 medium',
                    'tomatoes': '2 medium',
                    'cucumber': '1 large',
                    'carrot': '1 large',
                    'carrots': '2 medium'
                },
                instructions: instructions,
                timers: new Array(instructions.length).fill(0).map((_, i) => {
                    if (instructions[i].includes('wash')) return 3;
                    if (instructions[i].includes('cut') || instructions[i].includes('slice') || instructions[i].includes('grate') || instructions[i].includes('prepare')) return 2;
                    return 1;
                }),
                extras: ['3 tbsp olive oil', '2 tbsp vinegar', 'salt and pepper to taste']
            };
        }

        function generateBreadRecipe(ingredients) {
            const hasWheat = ingredients.some(ing => ing.toLowerCase().includes('wheat'));
            const hasFlour = ingredients.some(ing => ing.toLowerCase().includes('flour'));
            const hasYeast = ingredients.some(ing => ing.toLowerCase().includes('yeast'));
            const hasBread = ingredients.some(ing => ing.toLowerCase().includes('bread'));
            
            let recipeName;
            if (hasWheat && hasFlour) {
                recipeName = "Fresh Wheat Bread";
            } else if (hasFlour && hasYeast) {
                recipeName = "Homemade Bread";
            } else if (hasFlour) {
                recipeName = "Simple Flour Flatbread";
            } else if (hasBread) {
                recipeName = "Toasted Bread Dish";
            } else {
                recipeName = "Wheat-Based Dish";
            }
            
            const instructions = [];
            
            if (hasFlour && hasYeast) {
                instructions.push("In a large bowl, combine the flour with warm water");
                instructions.push("Add yeast and a pinch of sugar, let sit for 5 minutes until foamy");
                instructions.push("Mix in salt and knead the dough for 8-10 minutes until smooth");
                instructions.push("Place in an oiled bowl, cover and let rise for 1 hour");
                instructions.push("Punch down the dough and shape into a loaf");
                instructions.push("Let rise again for 30 minutes until doubled");
                instructions.push("Bake in preheated 375°F oven for 30-35 minutes until golden");
            } else if (hasFlour) {
                instructions.push("In a bowl, combine the flour with a pinch of salt");
                instructions.push("Gradually add warm water while mixing to form a dough");
                instructions.push("Knead briefly until the dough comes together");
                instructions.push("Divide into small portions and roll out thin");
                instructions.push("Cook in a hot dry pan for 2-3 minutes per side");
                instructions.push("Serve warm as flatbread");
            } else {
                instructions.push("Toast the bread slices until golden brown");
                instructions.push("Prepare any additional ingredients as toppings");
                instructions.push("Arrange toppings on the toasted bread");
                instructions.push("Serve immediately while the bread is still warm");
            }
            
            return {
                name: recipeName,
                servings: 4,
                amounts: {
                    'wheat': '2 cups ground',
                    'flour': '3 cups all-purpose',
                    'yeast': '1 packet active dry',
                    'bread': '4 slices'
                },
                instructions: instructions,
                timers: new Array(instructions.length).fill(0).map((_, i) => {
                    if (instructions[i].includes('rise')) return instructions[i].includes('1 hour') ? 60 : 30;
                    if (instructions[i].includes('bake')) return 32;
                    if (instructions[i].includes('knead')) return 9;
                    if (instructions[i].includes('foamy')) return 5;
                    if (instructions[i].includes('cook')) return 3;
                    return 2;
                }),
                extras: hasFlour ? ['1 tsp salt', '1 cup warm water'] : ['butter for serving']
            };
        }

        function generateVegetableRecipe(ingredients) {
            return {
                name: `Fresh Garden Vegetable Medley`,
                servings: 4,
                amounts: {
                    'vegetables': '4 cups mixed',
                    'tomato': '3 medium diced',
                    'onion': '1 large sliced',
                    'garlic': '2 cloves minced',
                    'herbs': '2 tbsp fresh'
                },
                instructions: [
                    "Wash and prepare all vegetables",
                    "Heat oil in a large pan",
                    "Sauté onions and garlic until fragrant",
                    "Add harder vegetables first, cook until slightly tender",
                    "Add remaining vegetables and herbs",
                    "Cook until all vegetables are tender-crisp and serve"
                ],
                timers: [5, 2, 3, 5, 3, 2],
                extras: ['3 tbsp olive oil', 'salt and pepper to taste']
            };
        }

        function generateFruitRecipe(ingredients) {
            const hasBanana = ingredients.some(ing => ing.toLowerCase().includes('banana'));
            const hasApple = ingredients.some(ing => ing.toLowerCase().includes('apple'));
            const hasBerries = ingredients.some(ing => ing.toLowerCase().includes('berr') || ing.toLowerCase().includes('strawb') || ing.toLowerCase().includes('blueb'));
            
            let recipeName;
            if (hasBanana && hasApple) {
                recipeName = "Mixed Fruit Salad";
            } else if (hasBerries) {
                recipeName = "Fresh Berry Mix";
            } else {
                recipeName = "Fresh Fruit Bowl";
            }
            
            const instructions = [];
            instructions.push("Wash all fruits thoroughly under cold water");
            
            ingredients.forEach(ingredient => {
                const ing = ingredient.toLowerCase();
                if (ing.includes('banana')) {
                    instructions.push("Peel and slice the bananas into rounds");
                } else if (ing.includes('apple')) {
                    instructions.push("Core and dice the apples into bite-sized pieces");
                } else if (ing.includes('berr') || ing.includes('strawb')) {
                    instructions.push("Hull and halve the berries if large");
                } else if (ing.includes('orange') || ing.includes('citrus')) {
                    instructions.push("Peel and segment the citrus fruits");
                } else {
                    instructions.push(`Prepare the ${ingredient} by cutting into appropriate pieces`);
                }
            });
            
            instructions.push("Combine all prepared fruits in a large serving bowl");
            instructions.push("Toss gently to mix and serve immediately while fresh");
            
            return {
                name: recipeName,
                servings: 3,
                amounts: {
                    'banana': '2 large',
                    'apple': '2 medium',
                    'berries': '1 cup',
                    'strawberry': '1 cup',
                    'blueberry': '1 cup',
                    'orange': '2 medium'
                },
                instructions: instructions,
                timers: new Array(instructions.length).fill(0).map((_, i) => {
                    if (instructions[i].includes('wash')) return 2;
                    if (instructions[i].includes('slice') || instructions[i].includes('dice') || instructions[i].includes('prepare')) return 3;
                    return 1;
                }),
                extras: ['honey for drizzling (optional)', 'lemon juice to prevent browning']
            };
        }

        function generateUniversalRecipe(ingredients) {
            // This will work with ANY ingredients
            const mainIngredients = ingredients.slice(0, 3); // Take first 3 ingredients for name
            const recipeName = `${mainIngredients.map(capitalizeFirst).join(' & ')} Creation`;
            
            const instructions = [];
            instructions.push("Gather and prepare all your ingredients");
            instructions.push("Clean and wash ingredients that need washing");
            
            // Generic cooking instructions that work for most ingredients
            const hasLiquid = ingredients.some(ing => 
                ['water', 'milk', 'broth', 'stock', 'juice', 'oil'].some(l => ing.toLowerCase().includes(l))
            );
            
            if (hasLiquid) {
                instructions.push("Heat your liquid ingredients in a pot or pan");
            } else {
                instructions.push("Heat a pan with a little oil over medium heat");
            }
            
            // Add ingredients based on cooking time (harder ingredients first)
            const hardIngredients = ingredients.filter(ing => 
                ['potato', 'carrot', 'beet', 'turnip', 'root'].some(h => ing.toLowerCase().includes(h))
            );
            
            if (hardIngredients.length > 0) {
                instructions.push("Add harder ingredients first and cook until they start to soften");
            }
            
            instructions.push("Add remaining ingredients and cook until everything is heated through");
            instructions.push("Season with salt, pepper, or any seasonings you have");
            instructions.push("Cook until all ingredients are tender and flavors are combined");
            instructions.push("Taste and adjust seasoning, then serve while warm");
            
            // Generate amounts for each ingredient
            const amounts = {};
            ingredients.forEach(ingredient => {
                amounts[ingredient] = getRandomAmount(ingredient);
            });
            
            return {
                name: recipeName,
                servings: Math.max(2, Math.min(4, ingredients.length)),
                amounts: amounts,
                instructions: instructions,
                timers: new Array(instructions.length).fill(0).map((_, i) => {
                    if (instructions[i].includes('cook until tender') || instructions[i].includes('soften')) return 12;
                    if (instructions[i].includes('heat') && instructions[i].includes('cook')) return 8;
                    if (instructions[i].includes('heat')) return 3;
                    if (instructions[i].includes('prepare') || instructions[i].includes('clean')) return 5;
                    return 2;
                }),
                extras: ['oil for cooking', 'salt and pepper to taste']
            };
        }

        function generateSimpleRecipe(ingredients) {
            // Fallback - just call universal recipe
            return generateUniversalRecipe(ingredients);
        }

        function getRandomAmount(ingredient) {
            const amounts = ['1 cup', '2 cups', '200g', '300g', '1 tbsp', '2 tbsp', '1 tsp', '2 tsp', '1', '2', '3'];
            return amounts[Math.floor(Math.random() * amounts.length)];
        }

        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }

        function updateAIGenerateButton(isLoading) {
            const btn = document.getElementById('aiGenerateBtn');
            const text = document.getElementById('aiGenerateText');
            
            if (isLoading) {
                btn.disabled = true;
                text.innerHTML = '<span class="loading-spinner"></span> Generating Recipe...';
            } else {
                btn.disabled = false;
                text.innerHTML = '🤖 Generate AI Recipe';
            }
        }

        // Initialize - show login page first
        document.addEventListener('DOMContentLoaded', function() {
            initializeTheme();
            loadNotesFromStorage();
            lucide.createIcons();
        });
    </script>
</body>
</html>
